<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UNIer - Tr·ª£ l√Ω h·ªçc ti·∫øng Anh</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/franc-min@6.2.0/franc-min.js"></script>
    <style>
      :root {
        --gradient-primary: linear-gradient(135deg, #4f46e5, #2563eb);
        --gradient-hover: linear-gradient(135deg, #4338ca, #1d4ed8);
        --primary-color: #4f46e5;
        --secondary-color: #2563eb;
        --bg-white: #ffffff;
        --text-dark: #1f2937;
        --text-light: #6b7280;
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.05);
        --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
        /* Bi·∫øn cho hi·ªáu ·ª©ng c·∫ßu v·ªìng nh·∫π nh√†ng */
        --rainbow: linear-gradient(90deg, #ff0000, #0000ff, #8000ff);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Plus Jakarta Sans", -apple-system, BlinkMacSystemFont,
          sans-serif;
        background: #f9fafb;
        color: var(--text-dark);
        line-height: 1.6;
        min-height: 100vh;
      }

      #welcome-section {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
        text-align: center;
        animation: fadeInUp 0.6s ease-out;
        transition: opacity 0.5s ease, transform 0.5s ease;
      }

      .logo-container {
        width: 140px;
        height: 140px;
        margin: 0 auto 24px;
        background: var(--gradient-primary);
        border-radius: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow-lg);
        transform: rotate(-5deg);
        transition: transform 0.3s ease;
        overflow: hidden;
        position: relative;
      }

      .logo-text {
        color: white;
        font-size: 48px;
        font-weight: 700;
        letter-spacing: -1px;
        line-height: 1;
      }

      .welcome-title {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 16px;
        animation: fadeInUp 0.8s ease-out;
      }

      .welcome-subtitle {
        font-size: 18px;
        color: var(--text-light);
        margin-bottom: 48px;
        animation: fadeInUp 1s ease-out;
      }

      .menu-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 24px;
        max-width: 1000px;
        margin: 0 auto;
        padding: 0 20px;
      }

      .menu-item {
        background: var(--bg-white);
        border-radius: var(--radius-lg);
        padding: 24px;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 20px;
        transition: all 0.3s ease;
        border: 1px solid rgba(0, 0, 0, 0.05);
        cursor: default;
        pointer-events: none;
        opacity: 0.9;
      }

      .menu-icon {
        width: 48px;
        height: 48px;
        background: var(--gradient-primary);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
      }

      .menu-content {
        flex: 1;
      }

      .menu-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 4px;
      }

      .menu-description {
        font-size: 14px;
        color: var(--text-light);
      }

      #chat-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        padding-bottom: 100px;
        display: none;
      }

      .message-container {
        margin: 20px 0;
        animation: fadeInUp 0.3s ease-out;
        position: relative;
      }

      .message {
        max-width: 85%;
        padding: 16px 20px;
        border-radius: var(--radius-md);
        font-size: 15px;
        line-height: 1.6;
        position: relative;
      }

      .user-message {
        margin-left: auto;
        background: var(--gradient-primary);
        color: white;
        border-bottom-right-radius: var(--radius-sm);
        animation: fadeInRight 0.3s ease-out;
      }

      .ai-message {
        margin-right: auto;
        background: var(--bg-white);
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-bottom-left-radius: var(--radius-sm);
        box-shadow: var(--shadow-sm);
        opacity: 0;
        transform: translateY(10px);
        animation: messageIn 0.5s ease-out forwards;
        position: relative;
      }

      /* Hi·ªáu ·ª©ng c·∫ßu v·ªìng nh·∫π nh√†ng v·ªõi 3 m√†u */
      .typing-rainbow {
        border: none;
        background: var(--bg-white);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        position: relative;
        z-index: 1;
      }

      .typing-rainbow::before {
        content: "";
        position: absolute;
        inset: -4px;
        background: var(--rainbow);
        background-size: 200% 200%;
        animation: rainbowPulse 3s linear infinite;
        filter: blur(5px);
        z-index: -1;
        opacity: 0.7;
      }

      .typing-rainbow::after {
        content: "";
        position: absolute;
        inset: 1px;
        background: var(--bg-white);
        border-radius: var(--radius-md);
        z-index: -1;
      }

      @keyframes rainbowPulse {
        0% {
          background-position: 0% 0%;
          box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
        }
        50% {
          background-position: 100% 100%;
          box-shadow: 0 0 15px rgba(0, 0, 255, 0.5);
        }
        100% {
          background-position: 200% 200%;
          box-shadow: 0 0 15px rgba(128, 0, 255, 0.5);
        }
      }

      .typing-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        background: var(--bg-white);
        border-radius: var(--radius-md);
        margin-bottom: 16px;
        animation: fadeIn 0.3s ease-out;
        width: fit-content;
        box-shadow: var(--shadow-sm);
      }

      .typing-dot {
        width: 8px;
        height: 8px;
        background: var(--primary-color);
        border-radius: 50%;
        opacity: 0.6;
        animation: typingDot 1s infinite;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typingDot {
        0%,
        100% {
          transform: translateY(0);
          opacity: 0.6;
        }
        50% {
          transform: translateY(-4px);
          opacity: 1;
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes fadeInRight {
        from {
          opacity: 0;
          transform: translateX(20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes messageIn {
        from {
          opacity: 0;
          transform: translateY(10px);
          filter: blur(4px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
          filter: blur(0);
        }
      }

      .text-reveal {
        transition: all 0.5s ease-out;
      }

      .fade-out {
        animation: fadeOut 0.5s ease-out forwards;
      }

      @keyframes fadeOut {
        to {
          opacity: 0;
          transform: translateY(-20px);
        }
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .input-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        padding: 20px;
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        z-index: 1000;
        transition: transform 0.3s ease; /* D√πng transform thay v√¨ bottom */
      }

      /* Ch·ªâ di chuy·ªÉn tr√™n mobile khi b√†n ph√≠m hi·ªán */
      @media (max-width: 768px) {
        .input-container.keyboard-active {
          transform: translateY(
            calc(-100% - 10px)
          ); /* N√¢ng l√™n tr√™n b√†n ph√≠m */
        }
      }

      .input-box {
        max-width: 1000px;
        margin: 0 auto;
        background: var(--bg-white);
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        padding: 8px;
        transition: all 0.3s ease;
      }

      .input-box:focus-within {
        border-color: var(--primary-color);
        box-shadow: var(--shadow-md);
      }

      #user-input {
        flex: 1;
        border: none;
        outline: none;
        padding: 12px 16px;
        font-size: 15px;
        font-family: inherit;
        resize: none;
        max-height: 120px;
        background: transparent;
      }

      #send-button {
        background: var(--gradient-primary);
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      #send-button:hover {
        background: var(--gradient-hover);
        transform: translateY(-2px);
      }

      #send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .section-title {
        color: var(--primary-color);
        font-size: 1.1em;
        font-weight: 600;
        margin: 16px 0 8px;
      }

      .highlight-text {
        color: var(--primary-color);
        font-weight: 500;
      }

      .example-box {
        background: rgba(79, 70, 229, 0.05);
        border-radius: var(--radius-sm);
        padding: 12px 16px;
        margin: 8px 0;
      }

      .info-pill {
        display: inline-flex;
        align-items: center;
        padding: 4px 12px;
        background: rgba(79, 70, 229, 0.1);
        border-radius: 12px;
        font-size: 0.9em;
        color: var(--primary-color);
        margin: 4px;
      }

      .tip {
        background: rgba(79, 70, 229, 0.05);
        padding: 12px 16px;
        border-radius: var(--radius-sm);
        margin: 8px 0;
      }

      .warning {
        background: rgba(245, 158, 11, 0.05);
        padding: 12px 16px;
        border-radius: var(--radius-sm);
        margin: 8px 0;
        color: #d97706;
      }

      @media (max-width: 768px) {
        .welcome-title {
          font-size: 24px;
        }
        .welcome-subtitle {
          font-size: 16px;
        }
        .menu-grid {
          grid-template-columns: 1fr;
          gap: 16px;
          padding: 0 10px;
        }
        .menu-item {
          padding: 16px;
        }
        .menu-icon {
          width: 40px;
          height: 40px;
          font-size: 20px;
        }
        .message {
          max-width: 90%;
          font-size: 14px;
        }
        .input-container {
          padding: 10px;
        }
        .input-box {
          padding: 6px;
        }
        #user-input {
          padding: 10px 12px;
          font-size: 14px;
        }
        #send-button {
          width: 36px;
          height: 36px;
        }
        .logo-container {
          width: 120px;
          height: 120px;
        }
        .logo-text {
          font-size: 40px;
        }
      }

      @media (max-width: 480px) {
        .logo-container {
          width: 100px;
          height: 100px;
        }
        .logo-text {
          font-size: 36px;
        }
        .welcome-title {
          font-size: 20px;
        }
        .welcome-subtitle {
          font-size: 14px;
          margin-bottom: 32px;
        }
        .menu-item {
          padding: 12px;
        }
        .menu-title {
          font-size: 16px;
        }
        .menu-description {
          font-size: 12px;
        }
        .message {
          padding: 12px 16px;
        }
        .input-container {
          padding: 8px;
        }
        #user-input {
          padding: 8px 10px;
        }
      }
    </style>
  </head>
  <body>
    <div id="welcome-section">
      <div class="logo-container">
        <div class="logo-text">U</div>
      </div>
      <h1 class="welcome-title">Ch√†o m·ª´ng ƒë·∫øn v·ªõi UNIer</h1>
      <p class="welcome-subtitle">Tr·ª£ l√Ω h·ªçc ti·∫øng Anh th√¥ng minh c·ªßa b·∫°n</p>

      <div class="menu-grid">
        <div class="menu-item">
          <div class="menu-icon">üìö</div>
          <div class="menu-content">
            <div class="menu-title">H·ªçc t·ª´ v·ª±ng</div>
            <div class="menu-description">Kh√°m ph√° t·ª´ m·ªõi theo ch·ªß ƒë·ªÅ</div>
          </div>
        </div>

        <div class="menu-item">
          <div class="menu-icon">üìù</div>
          <div class="menu-content">
            <div class="menu-title">Ng·ªØ ph√°p</div>
            <div class="menu-description">H·ªçc v√† th·ª±c h√†nh ng·ªØ ph√°p</div>
          </div>
        </div>

        <div class="menu-item">
          <div class="menu-icon">üó£Ô∏è</div>
          <div class="menu-content">
            <div class="menu-title">Ph√°t √¢m</div>
            <div class="menu-description">C·∫£i thi·ªán ph√°t √¢m c·ªßa b·∫°n</div>
          </div>
        </div>

        <div class="menu-item">
          <div class="menu-icon">üí≠</div>
          <div class="menu-content">
            <div class="menu-title">H·ªôi tho·∫°i</div>
            <div class="menu-description">Th·ª±c h√†nh giao ti·∫øp</div>
          </div>
        </div>

        <div class="menu-item">
          <div class="menu-icon">üéß</div>
          <div class="menu-content">
            <div class="menu-title">Luy·ªán nghe</div>
            <div class="menu-description">C·∫£i thi·ªán k·ªπ nƒÉng nghe</div>
          </div>
        </div>

        <div class="menu-item">
          <div class="menu-icon">‚úçÔ∏è</div>
          <div class="menu-content">
            <div class="menu-title">Luy·ªán vi·∫øt</div>
            <div class="menu-description">Ph√°t tri·ªÉn k·ªπ nƒÉng vi·∫øt</div>
          </div>
        </div>
      </div>
    </div>

    <div id="chat-container">
      <div id="chat-box"></div>
    </div>

    <div class="input-container">
      <div class="input-box">
        <textarea
          id="user-input"
          placeholder="Nh·∫≠p tin nh·∫Øn c·ªßa b·∫°n..."
          rows="1"
        ></textarea>
        <button id="send-button" onclick="sendMessage()">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
          >
            <path
              d="M22 2L11 13M22 2L15 22L11 13M11 13L2 9"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </button>
      </div>
    </div>

    <script>
      const CURRENT_TIME = "2025-04-07 08:41:52";
      const CURRENT_USER = "hieuuuues";
      const WORKER_URL = "https://openai-proxy.daotrunghieu080210.workers.dev";

      const chatBox = document.getElementById("chat-box");
      const userInput = document.getElementById("user-input");
      const sendButton = document.getElementById("send-button");
      const welcomeSection = document.getElementById("welcome-section");
      const chatContainer = document.getElementById("chat-container");

      let systemPrompt = {
        role: "system",
        content: `B·∫°n l√† UNIer ‚Äì tr·ª£ l√Ω h·ªçc ti·∫øng Anh **vui t√≠nh, l√©m l·ªânh, l·∫ßy nh·∫π nh∆∞ng th√¥ng minh c·ª±c ƒë·ªânh**, ƒë∆∞·ª£c ph√°t tri·ªÉn b·ªüi Trung Hi·∫øu.

‚è∞ Th·ªùi gian hi·ªán t·∫°i: ${CURRENT_TIME}
üë§ Ng∆∞·ªùi d√πng: ${CURRENT_USER}

üåü PHONG C√ÅCH ·ª®NG X·ª¨:
- T√≠nh c√°ch h√†i h∆∞·ªõc, d√≠ d·ªèm, ch·ªçc nh·∫π nh∆∞ng kh√¥ng qu√° ƒë√†.
- Tr·∫£ l·ªùi c√°c c√¢u h·ªèi ti·∫øng Anh theo c√°ch ‚Äúc∆∞·ªùi b√≤ nh∆∞ng v·∫´n hi·ªÉu b√†i‚Äù.
- Th·ªânh tho·∫£ng pha tr√≤, tung meme ng√¥n ng·ªØ, ho·∫∑c ‚Äúg·∫° k√®o‚Äù h·ªçc vui v·∫ª.
- Coi ng∆∞·ªùi d√πng l√† b·∫°n th√¢n: n√≥i chuy·ªán t·ª± nhi√™n, tho·∫£i m√°i nh∆∞ b·∫°n th√¢n t√°m chuy·ªán.

üéØ NHI·ªÜM V·ª§ CH√çNH:
- D·∫°y ti·∫øng Anh m√† kh√¥ng khi·∫øn ng∆∞·ªùi h·ªçc bu·ªìn ng·ªß nh∆∞‚Ä¶ h·ªçc l√Ω thuy·∫øt kh√¥ khan.
- Tr·∫£ l·ªùi m·ªçi th·ª© li√™n quan ƒë·∫øn ti·∫øng Anh: t·ª´ v·ª±ng, ng·ªØ ph√°p, ph√°t √¢m, k·ªπ nƒÉng s·ªëng c√≤n trong b√†i thi.
- T·∫°o kh√¥ng kh√≠ h·ªçc t·∫≠p "nh∆∞ ch∆°i game" ‚Äì d·ªÖ v√†o ƒë·∫ßu, kh√≥ qu√™n, v√† c·ª±c chill.

üìö PHONG C√ÅCH TR·∫¢ L·ªúI:
- [üî• Ch·ªß ƒë·ªÅ n√≥ng h·ªïi]
- **ƒêi·ªÉm ch√≠nh** (ƒë∆∞·ª£c gi·∫£i th√≠ch si√™u d·ªÖ hi·ªÉu v√† ƒë√¥i ch√∫t h√†i h∆∞·ªõc)
- > V√≠ d·ª• d·ªÖ nh·ªõ (Ti·∫øng Anh ‚Äì Ti·∫øng Vi·ªát) ‚Äì k√®m b√¨nh lu·∫≠n vui
- ‚Ä¢ G·ª£i √Ω luy·ªán t·∫≠p ki·ªÉu "th·ª≠ th√°ch b√° ƒë·∫°o"
- üí° M·∫πo h·ªçc b√° ƒë·∫°o
- ‚ö†Ô∏è L·ªói h·ªçc sinh th∆∞·ªùng d√≠nh ‚Äì v√† c√°ch tr√°nh nh∆∞ ninja

üß† T∆Ø DUY GI·∫¢NG D·∫†Y:
- Ph√¢n t√≠ch theo tr√¨nh ƒë·ªô ng∆∞·ªùi d√πng, kh√¥ng "ch√©m gi√≥" qu√° ƒë√†.
- V√≠ d·ª• lu√¥n s√°t v·ªõi ƒë·ªùi s·ªëng h·ªçc sinh, crush, ƒÉn h√†ng, deadline...
- Gi·∫£i th√≠ch k·ªπ nh∆∞ng lu√¥n k√®m v√≠ d·ª• h√†i ‚Äì gi√∫p nh·ªõ l√¢u h∆°n crush c≈©.
- Ph·∫£n h·ªìi ngay, kh√¥ng ƒë·ªÉ b·∫°n "ch·ªù nh∆∞ ƒë·ª£i ng∆∞·ªùi y√™u rep tin nh·∫Øn".

‚öôÔ∏è NGUY√äN T·∫ÆC ƒê√ÅNG Y√äU:
- Lu√¥n ∆∞u ti√™n tr·∫£ l·ªùi b·∫±ng ng√¥n ng·ªØ ng∆∞·ªùi d√πng (ti·∫øng Vi·ªát hay ti·∫øng Anh)
- K·∫øt h·ª£p song ng·ªØ khi d·∫°y ‚Äì v·ª´a h·ªçc v·ª´a hi·ªÉu.
- Duy tr√¨ t√≠nh **h√†i h∆∞·ªõc th√¢n thi·ªán** nh∆∞ng v·∫´n ƒë·∫£m b·∫£o t√≠nh chuy√™n m√¥n.

üëë ƒê·∫∂C BI·ªÜT:
- N·∫øu ng∆∞·ªùi d√πng sai: s·ª≠a l·ªói b·∫±ng c√°ch nh·∫π nh√†ng, ch·ªçc c∆∞·ªùi ƒë·ªÉ h·ªç nh·ªõ m√† kh√¥ng x·∫•u h·ªï.
- N·∫øu ng∆∞·ªùi d√πng ƒë√∫ng: tung hoa, th·ªïi k√®n, khen t·ªõi n√≥c (v√¨ b·∫°n x·ª©ng ƒë√°ng).
- N·∫øu ng∆∞·ªùi d√πng l∆∞·ªùi h·ªçc: g·∫° h·ªçc b·∫±ng c√°ch troll nh·∫π, d·ª• d·ªó b·∫±ng k·∫πo ti·∫øng Anh üòú

‚úÖ M·ª§C TI√äU:
Bi·∫øn ti·∫øng Anh t·ª´ ‚Äú√°c m·ªông" th√†nh ‚Äúcrush qu·ªëc d√¢n‚Äù ‚Äì b·∫°n h·ªçc xong th·∫•y y√™u ƒë·ªùi, y√™u c·∫£ ti·∫øng Anh v√†‚Ä¶ c√≥ th·ªÉ y√™u lu√¥n c·∫£ UNIer n·∫øu b·∫°n ch∆∞a c√≥ ng∆∞·ªùi y√™u üòâ`,
      };

      let conversationHistory = [systemPrompt];
      let currentContext = {
        level: "beginner",
        progress: 0,
        userId: CURRENT_USER,
        lastInteraction: CURRENT_TIME,
        language: "vi",
        lastTopic: "",
      };

      function showTypingIndicator() {
        const container = document.createElement("div");
        container.className = "message-container typing-container";
        const indicator = document.createElement("div");
        indicator.className = "typing-indicator";
        for (let i = 0; i < 3; i++) {
          const dot = document.createElement("div");
          dot.className = "typing-dot";
          indicator.appendChild(dot);
        }
        container.appendChild(indicator);
        chatBox.appendChild(container);
        container.scrollIntoView({ behavior: "smooth" });
        return container;
      }

      function removeTypingIndicator() {
        const typingContainer = document.querySelector(".typing-container");
        if (typingContainer) typingContainer.remove();
      }

      function formatResponse(text) {
        text = text
          .replace(/\n/g, "<br>")
          .replace(/\[([^\]]+)\]/g, '<h3 class="section-title">$1</h3>')
          .replace(
            /\*\*([^*]+)\*\*/g,
            '<strong class="highlight-text">$1</strong>'
          )
          .replace(
            /^>\s*(.+)$/gm,
            '<blockquote class="example-box">$1</blockquote>'
          )
          .replace(/^‚Ä¢\s*(.+)$/gm, '<div class="info-pill">$1</div>')
          .replace(/üí°\s*(.+)/g, '<div class="tip">üí° $1</div>')
          .replace(/‚ö†Ô∏è\s*(.+)/g, '<div class="warning">‚ö†Ô∏è $1</div>');
        return text;
      }

      async function animateTextReveal(text, container) {
        container.classList.add("typing-rainbow");
        const words = text.split(" ");
        let currentText = "";
        for (let i = 0; i < words.length; i++) {
          currentText += words[i] + " ";
          container.innerHTML = formatResponse(currentText);
          await new Promise((resolve) => setTimeout(resolve, 30));
        }
        container.style.opacity = "1";
        container.classList.remove("typing-rainbow");
      }

      function detectLanguage(text) {
        if (typeof franc !== "undefined") {
          const lang = franc(text, { minLength: 3 });
          return lang === "vie" ? "vi" : lang === "eng" ? "en" : "vi";
        } else {
          const vietnamesePattern =
            /[√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒë]/;
          return vietnamesePattern.test(text) ? "vi" : "en";
        }
      }

      function updatePlaceholder() {
        const topics = {
          "t·ª´ v·ª±ng": "H·ªèi v·ªÅ t·ª´ v·ª±ng...",
          "ng·ªØ ph√°p": "H·ªèi v·ªÅ ng·ªØ ph√°p...",
          "ph√°t √¢m": "H·ªèi v·ªÅ ph√°t √¢m...",
          "h·ªôi tho·∫°i": "Th·ª±c h√†nh h·ªôi tho·∫°i...",
          "luy·ªán nghe": "H·ªèi v·ªÅ luy·ªán nghe...",
          "luy·ªán vi·∫øt": "H·ªèi v·ªÅ vi·∫øt...",
        };
        userInput.placeholder =
          topics[currentContext.lastTopic] || "H√£y ƒë·∫∑t c√¢u h·ªèi v·ªÅ ti·∫øng Anh...";
      }

      async function getBotResponse(message) {
        try {
          currentContext.lastInteraction = CURRENT_TIME;
          currentContext.language = detectLanguage(message);

          const lowerMessage = message.toLowerCase();
          if (lowerMessage.includes("t·ª´ v·ª±ng"))
            currentContext.lastTopic = "t·ª´ v·ª±ng";
          else if (lowerMessage.includes("ng·ªØ ph√°p"))
            currentContext.lastTopic = "ng·ªØ ph√°p";
          else if (lowerMessage.includes("ph√°t √¢m"))
            currentContext.lastTopic = "ph√°t √¢m";
          else if (lowerMessage.includes("h·ªôi tho·∫°i"))
            currentContext.lastTopic = "h·ªôi tho·∫°i";
          else if (lowerMessage.includes("nghe"))
            currentContext.lastTopic = "luy·ªán nghe";
          else if (lowerMessage.includes("vi·∫øt"))
            currentContext.lastTopic = "luy·ªán vi·∫øt";
          else currentContext.lastTopic = "";

          conversationHistory.push({
            role: "user",
            content: message,
            name: currentContext.userId,
          });

          const response = await fetch(WORKER_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              model: "gpt-4",
              messages: conversationHistory,
              temperature: 0.7,
              max_tokens: 1000,
              user: currentContext.userId,
            }),
          });

          if (!response.ok)
            throw new Error(`HTTP error! status: ${response.status}`);
          const data = await response.json();
          if (!data.choices?.[0]?.message?.content)
            throw new Error("Invalid response format");

          const reply = data.choices[0].message.content;
          conversationHistory.push({ role: "assistant", content: reply });
          return reply;
        } catch (error) {
          console.error("API Error:", error);
          throw new Error(
            error.message.includes("429")
              ? "H·ªá th·ªëng ƒëang b·∫≠n. Vui l√≤ng th·ª≠ l·∫°i sau v√†i gi√¢y."
              : "C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i."
          );
        }
      }

      async function appendMessage(content, isUser = false) {
        const containerDiv = document.createElement("div");
        containerDiv.className = "message-container";
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${
          isUser ? "user-message" : "ai-message"
        }`;

        containerDiv.appendChild(messageDiv);
        chatBox.appendChild(containerDiv);

        if (isUser) {
          messageDiv.textContent = content;
        } else {
          await animateTextReveal(content, messageDiv);
        }

        messageDiv.scrollIntoView({ behavior: "smooth" });
      }

      async function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;

        try {
          setInputState(false);

          if (welcomeSection.style.display !== "none") {
            welcomeSection.classList.add("fade-out");
            setTimeout(() => {
              welcomeSection.style.display = "none";
              chatContainer.style.display = "block";
            }, 500);
          }

          appendMessage(message, true);
          clearInput();

          showTypingIndicator();
          const response = await getBotResponse(message);
          removeTypingIndicator();

          await appendMessage(response, false);
          updatePlaceholder();
        } catch (error) {
          removeTypingIndicator();
          appendMessage(error.message, false);
        } finally {
          setInputState(true);
        }
      }

      function setInputState(enabled) {
        userInput.disabled = !enabled;
        sendButton.disabled = !enabled;
        if (enabled) userInput.focus();
      }

      function clearInput() {
        userInput.value = "";
        userInput.style.height = "auto";
      }

      userInput.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = Math.min(this.scrollHeight, 200) + "px";
      });

      userInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // X·ª≠ l√Ω √¥ nh·∫≠p text tr√™n mobile
      let initialHeight = window.innerHeight;
      userInput.addEventListener("focus", () => {
        if (window.innerWidth <= 768) {
          const inputContainer = document.querySelector(".input-container");
          setTimeout(() => {
            const newHeight = window.innerHeight;
            if (newHeight < initialHeight) {
              // B√†n ph√≠m hi·ªán l√™n
              inputContainer.classList.add("keyboard-active");
            }
          }, 100);
        }
      });

      userInput.addEventListener("blur", () => {
        if (window.innerWidth <= 768) {
          const inputContainer = document.querySelector(".input-container");
          inputContainer.classList.remove("keyboard-active");
        }
      });

      window.addEventListener("resize", () => {
        if (window.innerWidth <= 768) {
          const inputContainer = document.querySelector(".input-container");
          const newHeight = window.innerHeight;
          if (newHeight >= initialHeight) {
            // B√†n ph√≠m ·∫©n
            inputContainer.classList.remove("keyboard-active");
          }
        }
      });

      window.onload = function () {
        setInputState(true);
        updatePlaceholder();

        appendMessage(
          `[Xin ch√†o]<br>
**Ch√†o m·ª´ng ƒë·∫øn v·ªõi UNIer!** üëã<br><br>
M√¨nh l√† tr·ª£ l√Ω h·ªçc ti·∫øng Anh c·ªßa b·∫°n. B·∫°n c√≥ th·ªÉ:<br>
‚Ä¢ H·ªèi b·∫•t k·ª≥ c√¢u h·ªèi n√†o v·ªÅ ti·∫øng Anh<br>
‚Ä¢ Y√™u c·∫ßu gi·∫£i th√≠ch t·ª´ v·ª±ng, ng·ªØ ph√°p<br>
‚Ä¢ Luy·ªán t·∫≠p ph√°t √¢m, h·ªôi tho·∫°i<br>
‚Ä¢ Nh·ªù s·ª≠a l·ªói v√† c·∫£i thi·ªán c√°ch vi·∫øt<br><br>
üí° H√£y ƒë·∫∑t c√¢u h·ªèi ho·∫∑c cho m√¨nh bi·∫øt b·∫°n mu·ªën h·ªçc g√¨ nh√©!`,
          false
        );
      };
    </script>
  </body>
</html>
