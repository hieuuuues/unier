<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UNIer - Trợ lý học tiếng Anh</title>
    <style>
      body {
        font-family: "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #f0f2f5;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .chat-container {
        width: 100%;
        max-width: 900px;
        height: 90vh;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .chat-header {
        background: #fff;
        padding: 15px 20px;
        border-bottom: 1px solid #e5e5e5;
        text-align: center;
        font-size: 1.5em;
        font-weight: 500;
        color: #333;
      }
      #chat-box {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        background: #f7f7f8;
      }
      .message {
        max-width: 80%;
        padding: 12px 18px;
        border-radius: 12px;
        font-size: 1em;
        line-height: 1.5;
        animation: fadeIn 0.3s ease-in;
      }
      .user-message {
        background: #007bff;
        color: #fff;
        align-self: flex-end;
      }
      .ai-message {
        background: #fff;
        color: #333;
        align-self: flex-start;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .ai-message p {
        margin: 5px 0;
      }
      .ai-message strong {
        color: #007bff;
      }
      .input-area {
        padding: 20px;
        background: #fff;
        border-top: 1px solid #e5e5e5;
        display: flex;
        align-items: center;
      }
      #user-input {
        flex: 1;
        padding: 12px 15px;
        font-size: 1em;
        border: 1px solid #ddd;
        border-radius: 20px;
        outline: none;
        resize: none;
        max-height: 100px;
        overflow-y: auto;
      }
      #user-input:focus {
        border-color: #007bff;
      }
      #send-button {
        margin-left: 10px;
        padding: 10px 20px;
        background: #007bff;
        color: #fff;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        transition: background 0.2s;
      }
      #send-button:hover {
        background: #0056b3;
      }
      #send-button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @media (max-width: 600px) {
        .chat-container {
          height: 100vh;
          border-radius: 0;
        }
        #chat-box {
          padding: 15px;
        }
        .input-area {
          padding: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <div class="chat-header">UNIer - Trợ lý học tiếng Anh</div>
      <div id="chat-box"></div>
      <div class="input-area">
        <textarea
          id="user-input"
          placeholder="Hỏi gì đó về tiếng Anh..."
        ></textarea>
        <button id="send-button" onclick="sendMessage()">Gửi</button>
      </div>
    </div>

    <script>
      const chatBox = document.getElementById("chat-box");
      const userInput = document.getElementById("user-input");
      const sendButton = document.getElementById("send-button");
      const apiKey =
        "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";
      let lastRequestTime = 0;
      const minRequestInterval = 2000;

      // Hàm kiểm tra ngôn ngữ đầu vào
      function isVietnamese(text) {
        return /[\u00C0-\u1EF9]/.test(text); // Kiểm tra ký tự tiếng Việt
      }

      // Hàm định dạng phản hồi dài
      function formatResponse(response, isVietnamese) {
        const sentences = response.split(/[.!?]+/).filter((s) => s.trim());
        let formatted = "";
        sentences.forEach((sentence, index) => {
          sentence = sentence.trim();
          if (sentence) {
            if (index === 0 && isVietnamese) {
              formatted += `<p><strong>${sentence}</strong></p>`; // Bôi đậm câu đầu bằng tiếng Việt
            } else if (index === 0) {
              formatted += `<p><strong>${sentence}</strong></p>`; // Bôi đậm câu đầu bằng tiếng Anh
            } else {
              formatted += `<p>${sentence}${
                /[.!?]$/.test(sentence) ? "" : "."
              }</p>`;
            }
          }
        });
        return formatted;
      }

      function appendMessage(content, className, isFormatted = false) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${className}`;
        messageDiv.innerHTML = isFormatted ? content : content;
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      async function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;

        const currentTime = Date.now();
        if (currentTime - lastRequestTime < minRequestInterval) {
          appendMessage(
            "Vui lòng chờ vài giây trước khi gửi tiếp!",
            "ai-message"
          );
          return;
        }

        appendMessage(message, "user-message");
        userInput.value = "";
        sendButton.disabled = true;
        appendMessage("Đang xử lý...", "ai-message system-message");

        try {
          const response = await getBotResponse(message);
          chatBox.removeChild(chatBox.lastChild); // Xóa "Đang xử lý..."
          const isVietnameseInput = isVietnamese(message);
          const formattedResponse = formatResponse(response, isVietnameseInput);
          appendMessage(formattedResponse, "ai-message", true);
          lastRequestTime = Date.now();
        } catch (error) {
          chatBox.removeChild(chatBox.lastChild);
          appendMessage(`Có lỗi xảy ra: ${error.message}`, "ai-message");
        } finally {
          sendButton.disabled = false;
        }
      }

      async function getBotResponse(message) {
        const isVietnameseInput = isVietnamese(message);
        for (let attempt = 0; attempt < 3; attempt++) {
          const response = await fetch(
            "https://api.openai.com/v1/chat/completions",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${apiKey}`,
              },
              body: JSON.stringify({
                model: "gpt-4o", // Mô hình xịn nhất (kiểm tra tài liệu OpenAI nếu cần)
                messages: [
                  {
                    role: "system",
                    content:
                      "Bạn là UNIer, một trợ lý học tiếng Anh thân thiện. Nếu người dùng nhắn bằng tiếng Anh, trả lời tự nhiên bằng tiếng Anh như một gia sư. Nếu nhắn bằng tiếng Việt, trả lời tự nhiên bằng tiếng Việt. Giúp giải thích từ vựng, ngữ pháp, phát âm, đưa ví dụ thực tế, và sửa lỗi nhẹ nhàng nếu cần. Khuyến khích người học.",
                  },
                  { role: "user", content: message },
                ],
                max_tokens: 1000,
                temperature: 0.7,
              }),
            }
          );

          if (response.status === 429) {
            const retryAfter = response.headers.get("Retry-After") || 2;
            await new Promise((resolve) =>
              setTimeout(resolve, retryAfter * 1000)
            );
            continue;
          }

          if (response.status === 401) {
            throw new Error(
              "API Key không hợp lệ hoặc không có quyền truy cập GPT-4o. Kiểm tra lại!"
            );
          }

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(
              `Không kết nối được với API: ${response.status} - ${errorText}`
            );
          }

          const data = await response.json();
          if (!data.choices || !data.choices[0] || !data.choices[0].message) {
            throw new Error("Phản hồi API không hợp lệ");
          }
          return data.choices[0].message.content;
        }
        throw new Error("Quá nhiều lần thử lại do lỗi 429");
      }

      // Send message on Enter key
      userInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Auto-resize textarea
      userInput.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = `${this.scrollHeight}px`;
      });
    </script>
  </body>
</html>
